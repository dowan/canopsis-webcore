<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/mixins/calendarsourceuserevents.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <script src="../../doc-config.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>
<div id="main">

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Widgets</h3><ul><li><a href="widget_calendar.html"><img src="icons/application_view_gallery.png" alt="widget"/> calendar</a></li></ul><h3>Schemas</h3><ul><li><a href="schema_calendar.html"><img src="icons/table.png" alt="schema"/> calendar</a></li><li><a href="schema_calendarday.html"><img src="icons/table.png" alt="schema"/> calendarday</a></li><li><a href="schema_calendarevent.html"><img src="icons/table.png" alt="schema"/> calendarevent</a></li><li><a href="schema_calendarsourcepbehavior.html"><img src="icons/table.png" alt="schema"/> calendarsourcepbehavior</a></li><li><a href="schema_calendarsourceuserevents.html"><img src="icons/table.png" alt="schema"/> calendarsourceuserevents</a></li><li><a href="schema_eventcategories.html"><img src="icons/table.png" alt="schema"/> eventcategories</a></li></ul><h3>Adapters</h3><ul><li><a href="adapter_calendardata.html"><img src="icons/disconnect.png" alt="adapter"/> calendardata</a></li><li><a href="adapter_calendarday.html"><img src="icons/disconnect.png" alt="adapter"/> calendarday</a></li></ul><h3>Classes</h3><ul><li><a href="canopsis.frontend.brick-calendar.module_eventcategories%2520component.html">eventcategories component</a></li><li><a href="canopsis.frontend.brick-calendar.module_viewMixin.html">viewMixin</a></li></ul><h3>Mixins</h3><ul><li><a href="module-calendarsourceeventlog.html"><img src="icons/brick.png" alt="mixin"/> calendarsourceeventlog</a></li><li><a href="module-calendarsourcepbehavior.html"><img src="icons/brick.png" alt="mixin"/> calendarsourcepbehavior</a></li><li><a href="module-calendarsourceuserevents.html"><img src="icons/brick.png" alt="mixin"/> calendarsourceuserevents</a></li></ul>
</nav>


    <h1 class="page-title">Source: src/mixins/calendarsourceuserevents.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
 * Copyright (c) 2015 "Capensis" [http://www.capensis.com]
 *
 * This file is part of Canopsis.
 *
 * Canopsis is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Canopsis is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Canopsis. If not, see &lt;http://www.gnu.org/licenses/>.
 */


Ember.Application.initializer({
    name:'CalendarSourceUserEventsMixin',
    after: ['DataUtils', 'FormsUtils'],
    initialize: function(container, application) {
        var dataUtils = container.lookupFactory('utility:data');
        var formUtils = container.lookupFactory('utility:forms');
        var Mixin = container.lookupFactory('factory:mixin');

        var get = Ember.get,
            set = Ember.set,
            isNone = Ember.isNone,
            moment = window.moment,
            __ = window.__;

        /**
         * This is the calendar source userevent mixin.
         * This mixin is only available for the widget calendar
         *
         * @mixin calendarsourceuserevents
         */
        var mixin = Mixin('calendarsourceuserevents', {
            init: function() {
                this._super();

                set(this, 'selectedEvent', {});
                set(this, 'userevent', []);
            },

            /**
             * Call methods after the mixins load
             * @method mixinsOptionsReady
             */
            mixinsOptionsReady: function () {
                this._super();
                this.setEventcategories();
            },

            /**
             * Rerender user events when the calendar view is refreshed
             * @method renderUserEvents
             */
            renderUserEvents: function () {
                var controller = this;
                var listedCategories = get(controller, 'model.userevent_filters');

                if (!isNone(listedCategories)) {
                    for (var j = 0, lCLength = listedCategories.length; j &lt; lCLength; j++) {
                        // if the behavior is checked, remove the old source and load the new one
                        if(get(listedCategories[j], 'checked') === 'fa-check-square-o') {
                            controller.removeUserEvents(get(listedCategories[j], 'category'));
                            var uePromises = [controller.loadUserEvents(get(listedCategories[j], 'category'))];
                            controller.onSourceLoad(uePromises, ['reDrawUserEvents'], get(listedCategories[j], 'category'));
                        }
                    }
                }
            },

            /**
             * get categories from database and set them on the controller
             * @method setEventCategories
             * @param {controller} caller controller scope if needful
             */
            setEventcategories: function(caller) {

                var controller = this;
                var userevent = get(controller, 'userevent'),
                    listedCategories = get(controller, 'model.userevent_filters') || [];
                console.log('les userpref', listedCategories);

                if (!isNone(caller)) {
                    controller = caller;
                }

                var store = get(controller, 'widgetDataStore');

                store.findQuery('eventcategories', {}).then(function(queryResults) {
                    // if no result, warn the developer about it and quit the method
                    if (get(queryResults, 'content.length') === 0){
                        console.warn('no eventcategories was found in database');
                        return;
                    }

                    var eventCategoriesRecord = get(queryResults, 'content')[0];
                    var eventcategories = get(eventCategoriesRecord, 'eventcategories'),
                        i,
                        length = 0,
                        userPreferences = [];

                    for (i=0, length = listedCategories.length; i &lt; length; i++) {
                        var listedCategory = listedCategories[i];
                        var category = get(listedCategory, 'category');
                        userPreferences[category] = {
                            check: get(listedCategory, 'checked')
                        };
                    }

                    for (i=0, length = eventcategories.length; i &lt; length; i++) {
                        var eventcategory = eventcategories[i];
                        set(eventcategory, 'style', 'background-color:' + get(eventcategory, 'color') + ';');

                        var categoryCheck = userPreferences[get(eventcategory, 'category')] || {check : 'fa-square-o'};
                        set(eventcategory, 'checked', get(categoryCheck, 'check'));
                        userevent.pushObject({
                            name: eventcategory.category,
                            events: [],
                            color: eventcategory.color,
                            textColor: 'black'
                        });
                    }

                    set(controller, 'model.userevent_filters', eventcategories);
                    controller.saveUserConfiguration();
                    set(controller, 'userevent', userevent);

                });
            },

            /**
             * Remove the event source relative to the given category
             * @method removeUserEvents
             * @param {string/object} category could be a string or an object containing fields relative to the event source
             */
            removeUserEvents: function (category) {
                var controller = this;
                if (typeof category === 'string') {
                    var userevent = get(controller, 'userevent');
                    for (var i = 0, ueLength = userevent.length; i &lt; ueLength; i++) {
                        if (get(userevent[i], 'name') === category) {
                            controller.trigger('removeEventCalendar', userevent[i]);
                        }
                    }
                }
                else {
                    controller.trigger('removeEventCalendar', category);
                }
            },

            /**
             * Display on the fullcalendar an event source just loaded from database
             * @method reDrawUserEvents
             * @param {class} controller widget controller
             * @param {string/object} category could be a string or an object containing fields relative to the event source
             */
            reDrawUserEvents: function (controller, category) {
                if (typeof category === 'string') {
                    var userevent = get(controller, 'userevent');
                    for (var i = 0, ueLength = userevent.length; i &lt; ueLength; i++) {
                        if (get(userevent[i], 'name') === category) {
                            controller.trigger('addEventCalendar', userevent[i]);
                        }
                    }
                }
                else {
                    controller.trigger('addEventCalendar', category);
                }
            },

            /**
             * Get user events from calendardata collection
             * @method loadUserEvents
             * @param {string} category category to load
             */
            loadUserEvents: function(category) {
                var controller = this;
                var store = get(controller, 'widgetDataStore'),
                    userevent = get(controller, 'userevent'),
                    result = [],
                    promise;

                result.pushObject({'eventcategories': {'$eq': category}});
                var query = JSON.stringify({'$or': result});

                controller.getDateCalendarView();

                // query to select events (by filters)
                var userEventsParams = {
                    dtstart: get(this, 'calendarStart'),
                    dtend: get(this, 'calendarEnd'),
                    query: query
                };
                promise = store.findQuery('calendardata', userEventsParams).then(function (result) {
                    var events = get(result, 'content'),
                        calendarTab = [],
                        eventslength = events.length;

                    for (var i = 0, li = eventslength; i &lt; li; i++) {
                        var formated_cevent = controller.getCalendarEvent(events[i]);
                        calendarTab.pushObject(formated_cevent);
                    }

                    for (var j = 0, ueLength = userevent.length; j &lt; ueLength; j++) {
                        if (userevent[j].name === category) {
                            userevent[j].events = calendarTab;
                        }
                    }
                    set(controller, 'userevent', userevent);
                });

                return promise;

            },

            /**
             * Format the calendar event for fullCalendar
             * @method getCalendarEvent
             * @param {object} cevent object that contains event to format
             * @return {object}
             */
            getCalendarEvent: function (cevent) {

                var title = get(cevent, 'output');
                return {
                    id: get(cevent, 'id'),
                    type: 'userevent',
                    title: title,
                    eventcategories: get(cevent, 'eventcategories'),
                    start: moment(get(cevent, 'dtstart')*1000).format(),
                    end: moment(get(cevent, 'dtend')*1000).format()
                };
            },

            /**
             * Create an user event from the selected time range in the calendar
             * @method createSelectedEvent
             * @param {Number} start started timestamp given by the user selection
             * @param {Number} end ended timestamp given by the user selection
             */
            createSelectedEvent: function(start, end) {

                var controller = this;

                var eventCalendarRecord = dataUtils.getStore().createRecord('calendardata', {
                    crecord_type: 'calendardata',
                    dtstart: start,
                    dtend: end
                });
                var recordWizard = formUtils.showNew('modelform', eventCalendarRecord, {
                    title: __('Create a new calendar event')
                });

                // creation of the event and inform the user of this action by a message
                recordWizard.submit.then(function(form){
                    eventCalendarRecord = form.get('formContext');
                    var beginDate = get(eventCalendarRecord, 'dtstart'),
                        endDate = get(eventCalendarRecord, 'dtend'),
                        cat = get(eventCalendarRecord, 'eventcategories');

                    // dates no filled
                    if (isNone(beginDate) || isNone(endDate)) {
                        console.warn('Dates have to be filled');
                        controller.showUserMessage(
                            'Creation problem: dates have to be filled',
                            'danger'
                        );
                        return;
                    }

                    // submission stopped if dates are not correct
                    if (beginDate > endDate) {
                        console.warn('The starting date is after the ending date');
                        controller.showUserMessage(
                            'Creation problem: dates are not correct',
                            'danger'
                        );
                        return;
                    }

                    // submission stopped if there is no category
                    if (isNone(cat)) {
                        console.warn('No eventcategories was chosen during the event creation');
                        controller.showUserMessage(
                            'No eventcategories was chosen during the event creation',
                            'danger'
                        );
                        return;
                    }

                    console.warn('eventCalendarRecord', get(eventCalendarRecord, 'dtstart'));
                    eventCalendarRecord.save()
                        .then(function(){
                            controller.showUserMessage(
                                'Event save success',
                                'success'
                            );
                            var listedCategories = get(controller, 'model.userevent_filters');
                            // if there is userevent userpref, do something...
                            if (!isNone(listedCategories)) {
                                for (var j = 0, lCLength = listedCategories.length; j &lt; lCLength; j++) {
                                    var category = get(listedCategories[j], 'category');

                                    // if the category is checked, remove the old source and load the new one
                                    if(get(listedCategories[j], 'checked') === 'fa-check-square-o') {
                                        controller.removeUserEvents(category);
                                        var uePromises = [controller.loadUserEvents(category)];
                                        controller.onSourceLoad(uePromises, ['reDrawUserEvents'], category);
                                    }
                                }
                            }
                        });
                });
            },

            actions: {

                /**
                 * Set selected event and display edition choice
                 * @method onClickuserevent
                 * @param {object} calEvent fullcalendar event
                 * @param {object} jsEvent Javascript catched event
                 * @param {view} view view scope
                 */
                onClickuserevent: function (calEvent, jsEvent, view) {
                    var localView = view.$('.eventControls');
                    localView
                        .stop()
                        .fadeIn(350)
                        .css('left', jsEvent.clientX + 'px')
                        .css('top',(jsEvent.clientY - 20) + 'px');
                    set(this, 'selectedEvent', calEvent);
                },

                /**
                 * Create an user event from the "add event" form in the widget
                 * @method createEvent
                 */
                createEvent: function() {
                    var controller = this;

                    var eventCalendarRecord = dataUtils.getStore().createRecord('calendardata', {
                        crecord_type: 'calendardata'
                    });

                    var recordWizard = formUtils.showNew('modelform', eventCalendarRecord, {
                        title: __('Create a new calendar event')
                    });

                    // creation of the event and inform the user of this action by a message
                    recordWizard.submit.then(function(form){
                        eventCalendarRecord = form.get('formContext');
                        var beginDate = get(eventCalendarRecord, 'dtstart'),
                            endDate = get(eventCalendarRecord, 'dtend'),
                            cat = get(eventCalendarRecord, 'eventcategories');

                        // dates no filled
                        if (isNone(beginDate) || isNone(endDate)) {
                            console.warn('Dates have to be filled');
                            controller.showUserMessage(
                                'Creation problem: dates have to be filled',
                                'danger'
                            );
                            return;
                        }

                        // submission stopped if dates are not correct
                        if (beginDate > endDate) {
                            console.warn('The starting date is after the ending date');
                            controller.showUserMessage(
                                'Creation problem: dates are not correct',
                                'danger'
                            );
                            return;
                        }

                        // submission stopped if there is no category
                        if (isNone(cat)) {
                            console.warn('No eventcategories was chosen during the event creation');
                            controller.showUserMessage(
                                'No eventcategories was chosen during the event creation',
                                'danger'
                            );
                            return;
                        }

                        eventCalendarRecord.save()
                            .then(function(){
                                controller.showUserMessage(
                                    'Event saved success',
                                    'success'
                                );
                                var listedCategories = get(controller, 'model.userevent_filters');
                                // if there is userevent userpref, do something...
                                if (!isNone(listedCategories)) {
                                    for (var j = 0, lCLength = listedCategories.length; j &lt; lCLength; j++) {
                                        // if the category is checked, remove the old source and load the new one
                                        if(get(listedCategories[j], 'checked') === 'fa-check-square-o') {
                                            controller.removeUserEvents(get(listedCategories[j], 'category'));
                                            var uePromises = [controller.loadUserEvents(get(listedCategories[j], 'category'))];
                                            controller.onSourceLoad(uePromises, ['reDrawUserEvents'], get(listedCategories[j], 'category'));
                                        }
                                    }
                                }
                            });
                    });

                },

                /**
                 * Remove the selected event
                 * @method removeEvent
                 */
                removeEvent: function () {
                    var controller = this;
                    var store = get(controller, 'widgetDataStore'),
                        selectedEvent = get(controller, 'selectedEvent');

                    var params = {
                        dtstart: selectedEvent.start.format('X'),
                        dtend: selectedEvent.end.format('X'),
                        id: selectedEvent.id
                    };

                    // remove the event on the fullcalendar
                    controller.trigger('removeUserEvent');

                    var result = [];
                    result.pushObject({
                        'uid': {
                            '$eq': params.id
                        }
                    });
                    var query = JSON.stringify({'$or': result});
                    controller.getDateCalendarView();

                    // query to select the event (by filters)
                    var userEventsParams = {
                        dtstart: params.dtstart,
                        dtend: params.dtend,
                        query: query
                    };

                    // remove the event on the database
                    store.findQuery('calendardata', userEventsParams).then(function (result) {
                        var events = get(result, 'content');
                        events[0].destroyRecord();
                        controller.showUserMessage(
                            'the event was successfully removed',
                            'success'
                        );
                    });
                },

                /**
                 * Update one or several field(s) of the selected event
                 * @method updateEvent
                 */
                updateEvent: function () {
                    var controller = this;
                    var store = get(controller, 'widgetDataStore'),
                        selectedEvent = get(controller, 'selectedEvent');

                    var params = {
                        dtstart: selectedEvent.start.format('X'),
                        dtend: selectedEvent.end.format('X'),
                        id: selectedEvent.id
                    };

                    var result = [];
                    result.pushObject({
                        'uid': {
                            '$eq': params.id
                        }
                    });
                    var query = JSON.stringify({'$or': result});
                    controller.getDateCalendarView();

                    // query to select the event (by filters)
                    var userEventsParams = {
                        dtstart: params.dtstart,
                        dtend: params.dtend,
                        query: query
                    };

                    // find the event to update
                    store.findQuery('calendardata', userEventsParams).then(function (result) {

                        var events = get(result, 'content');

                        var eventCalendarRecord = {
                            crecord_type: 'calendardata',
                            eventcategories: get(events[0], 'eventcategories'),
                            output: get(events[0], 'output'),
                            dtstart: get(events[0], 'dtstart'),
                            dtend: get(events[0], 'dtend')
                        };

                        // create a form with event information
                        var recordWizard = formUtils.showNew('modelform', eventCalendarRecord, {
                            title: __('Edit this calendar event')
                        });

                        recordWizard.submit.then(function(form){
                            eventCalendarRecord = form.get('formContext');
                            var beginDate = get(eventCalendarRecord, 'dtstart'),
                                endDate = get(eventCalendarRecord, 'dtend'),
                                output = get(eventCalendarRecord, 'output'),
                                category = get(eventCalendarRecord, 'eventcategories');

                            // submission stopped if dates are not correct
                            if (beginDate > endDate) {
                                console.warn('The starting date is after the ending date');
                                controller.showUserMessage(
                                    'Creation problem: dates are not correct',
                                    'danger'
                                );
                                return;
                            }

                            // submission stopped if there is no category
                            if (isNone(category)) {
                                console.warn('No eventcategories was chosen during the event creation');
                                controller.showUserMessage(
                                    'No eventcategories was chosen during the event creation',
                                    'danger'
                                );
                                return;
                            }
                            set(events[0], 'dtstart', beginDate);
                            set(events[0], 'dtend', endDate);
                            set(events[0], 'output', output);
                            set(events[0], 'eventcategories', category);

                            // update the event
                            events[0].save()
                                .then(function(){
                                    controller.showUserMessage(
                                        'Event modification success',
                                        'success'
                                    );
                                    var listedCategories = get(controller, 'model.userevent_filters');

                                    // if there is userevent userpref, do something...
                                    if (!isNone(listedCategories)) {
                                        for (var j = 0, lCLength = listedCategories.length; j &lt; lCLength; j++) {
                                            // if the category is checked, remove the old source and load the new one
                                            if(get(listedCategories[j], 'checked') === 'fa-check-square-o') {
                                                controller.removeUserEvents(get(listedCategories[j], 'category'));
                                                var uePromises = [controller.loadUserEvents(get(listedCategories[j], 'category'))];
                                                controller.onSourceLoad(uePromises, ['reDrawUserEvents'], get(listedCategories[j], 'category'));
                                            }
                                        }
                                    }

                                });

                        });

                    });
                },

                /**
                 * Show/hide user events by clicking on the relatives category
                 * @method showUserEvents
                 */
                showUserEvents: function (category) {
                    var controller = this;
                    var userevent = get(controller, 'userevent'),
                        listedCategories = get(controller, 'model.userevent_filters');
                    // if no user configuration, set them to []
                    if (isNone(listedCategories)) {
                        listedCategories = [];
                    }
                    for (var i = 0, lcLength = listedCategories.length; i &lt; lcLength; i++) {
                        if (listedCategories[i].category === category.category) {
                            // update userprefs
                            var style = listedCategories[i].checked === 'fa-square-o' ? 'fa-check-square-o': 'fa-square-o';
                            set(listedCategories[i], 'checked', style);

                            set(controller, 'model.userevent_filters', listedCategories);
                            controller.saveUserConfiguration();

                            // if unchecked button, remove relative events
                            if(style === 'fa-square-o') {
                                for (var j = 0, usereventLength = userevent.length; j &lt; usereventLength; j++) {
                                    if (userevent[j].name === category.category) {
                                        controller.removeUserEvents(userevent[j]);
                                        userevent[j].events = [];
                                    }
                                }
                            }
                            // if checked button add relative events
                            else {
                                for (var k = 0, ueLength = userevent.length; k &lt; ueLength; k++) {
                                    if (userevent[k].name === category.category) {
                                        var promises = [controller.loadUserEvents(category.category)];
                                        controller.onSourceLoad(promises, ['reDrawUserEvents'], userevent[k]);
                                    }
                                }
                            }
                        }
                    }
                    set(controller, 'userevent', userevent);
                },

                /**
                 * open a form to edit eventcategories
                 * @method editCategories
                 */
                editCategories: function () {
                    var controller = this;
                    var container = get(this, 'container'),
                        listedCategories = get(controller, 'model.userevent_filters');

                    formUtils.editSchemaRecord('eventcategories', container, function () {
                        if (!isNone(listedCategories)) {
                            for (var j = 0, lCLength = listedCategories.length; j &lt; lCLength; j++) {
                                // if the behavior is checked, remove the old source
                                if(get(listedCategories[j], 'checked') === 'fa-check-square-o') {
                                    controller.removeUserEvents(get(listedCategories[j], 'category'));
                                }
                            }
                        }
                        set(controller, 'userevent', []);
                        controller.setEventcategories();
                        controller.renderUserEvents();
                    });
                }
            }
        });

        application.register('mixin:calendarsourceuserevents', mixin);
    }
});
</code></pre>
        </article>
    </section>




</div>


<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Apr 14 2016 16:26:18 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
