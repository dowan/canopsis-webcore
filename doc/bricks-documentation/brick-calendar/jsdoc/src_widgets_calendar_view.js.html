<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/widgets/calendar/view.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <script src="../../doc-config.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>
<div id="main">

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Widgets</h3><ul><li><a href="widget_calendar.html"><img src="icons/application_view_gallery.png" alt="widget"/> calendar</a></li></ul><h3>Schemas</h3><ul><li><a href="schema_calendar.html"><img src="icons/table.png" alt="schema"/> calendar</a></li><li><a href="schema_calendarday.html"><img src="icons/table.png" alt="schema"/> calendarday</a></li><li><a href="schema_calendarevent.html"><img src="icons/table.png" alt="schema"/> calendarevent</a></li><li><a href="schema_calendarsourcepbehavior.html"><img src="icons/table.png" alt="schema"/> calendarsourcepbehavior</a></li><li><a href="schema_calendarsourceuserevents.html"><img src="icons/table.png" alt="schema"/> calendarsourceuserevents</a></li><li><a href="schema_eventcategories.html"><img src="icons/table.png" alt="schema"/> eventcategories</a></li></ul><h3>Adapters</h3><ul><li><a href="adapter_calendardata.html"><img src="icons/disconnect.png" alt="adapter"/> calendardata</a></li><li><a href="adapter_calendarday.html"><img src="icons/disconnect.png" alt="adapter"/> calendarday</a></li></ul><h3>Classes</h3><ul><li><a href="canopsis.frontend.brick-calendar.module_eventcategories%2520component.html">eventcategories component</a></li><li><a href="canopsis.frontend.brick-calendar.module_viewMixin.html">viewMixin</a></li></ul><h3>Mixins</h3><ul><li><a href="module-calendarsourceeventlog.html"><img src="icons/brick.png" alt="mixin"/> calendarsourceeventlog</a></li><li><a href="module-calendarsourcepbehavior.html"><img src="icons/brick.png" alt="mixin"/> calendarsourcepbehavior</a></li><li><a href="module-calendarsourceuserevents.html"><img src="icons/brick.png" alt="mixin"/> calendarsourceuserevents</a></li></ul>
</nav>


    <h1 class="page-title">Source: src/widgets/calendar/view.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Copyright (c) 2015 "Capensis" [http://www.capensis.com]
 *
 * This file is part of Canopsis.
 *
 * Canopsis is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Canopsis is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Canopsis. If not, see &lt;http://www.gnu.org/licenses/>.
 */

Ember.Application.initializer({
    name: 'CalendarView',
    initialize: function(container, application) {

        var get = Ember.get,
            set = Ember.set,
            isNone = Ember.isNone;

        /**
         * This mixin is the widget's view.
         *
         * @class viewMixin
         * @memberOf canopsis.frontend.brick-calendar
         */
        var view = Ember.Mixin.create({

            /**
             * Synchronize selected calendar width to the widget
             * @method getCalendarWidth
             */
            getCalendarWidth: function () {
                var controller = get(this, 'controller');
                return 'max-width:' + get(controller, 'calendar_width') + '%';
            }.property('calendar_width'),

            /**
             * Add a new fullcalendar eventSource
             * @method addEventCalendar
             * @param {array} calendarTab eventSource as an array formated for fullCalendar
             */
            addEventCalendar: function(calendarTab) {
                // TODO find other solution: on refresh of the mixin this.$('.calendar') is undefined...
                var calendar = this.$('.calendar');

                if(isNone(calendar)) {
                    return;
                }
                calendar.fullCalendar( 'addEventSource', {
                    events: calendarTab.events,
                    color: calendarTab.color,
                    textColor: calendarTab.textColor
                });
            },

            /**
             * remove a old fullcalendar eventSource
             * @method removeEventCalendar
             * @param {array} calendarTab eventSource as an array formated for fullCalendar
             */
            removeEventCalendar: function (calendarTab) {
                var calendar = this.$('.calendar');

                if(isNone(calendar)) {
                    return;
                }
                if (!isNone(calendarTab)) {
                    calendar.fullCalendar('removeEventSource', calendarTab);
                }
            },

            /**
             * Remove only one selected event from the fullcalendar, getting it from the controller
             * @method removeUserEvent
             */
            removeUserEvent: function () {
                var controller = get(this, 'controller');
                var userEvent = get(controller, 'selectedEvent');
                if (!isNone(userEvent)) {
                    this.$('.calendar').fullCalendar('removeEvents', userEvent.id);
                }
            },

            /**
             * call the fullcalendar gotoDate method with the given date
             * @method goToDate
             * @param {number} date timestamp which represents the date to switch on
             */
            goToDate: function (date) {
                this.$('.calendar').fullCalendar('gotoDate', date);
            },

            refreshView: function () {this.willDestroyElement();this.didInsertElement();},

            /**
             * Create the fullcalendar at the beginning and catch every changed view
             * @method didInsertElement
             */
            didInsertElement: function () {
                this._super.apply(this, arguments);
                var globalView = this;
                var controller = get(globalView, 'controller');

                var calendarTab = [];
                var calendar = globalView.$('.calendar');
                globalView.$('.eventControls').hide();

                // Create fullCalendar
                calendar.fullCalendar({
                    header: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'month,basicWeek,basicDay'
                    },
                    fixedWeekCount : false,
                    editable: false,
                    eventLimit: true,
                    lazyFetching: false,
                    selectable: true,
                    selectHelper: true,
                    aspectRatio: 2,

                    /**
                     * Let the user to create an event by selecting a time range on the calendar
                     * @method select
                     * @param {date} start started date given by the selection
                     * @param {date} end ended date given by the selection
                     */
                    select: function(start, end) {
                        var controller = get(globalView, 'controller');
                        controller.createSelectedEvent(start.format('X'), end.format('X'));
                        calendar.fullCalendar('unselect');
                    },

                    /**
                     * Refresh each source event after
                     * @method viewRender
                     * @param {CalendarView} month current view to refresh
                     * @param {calendar} calendar the concerned calendar element
                     */
                    viewRender: function(month, calendar) {
                        void(calendar);
                        var controller = get(globalView, 'controller');
                        var calendarView = globalView.$('.calendar').fullCalendar('getView');
                        calendarView.start.add(5, 'd');
                        calendarView.start.startOf('month');

                        if (get(controller, 'model.started_date') !== calendarView.start.format('X') || get(controller, 'reload')) {
                            if (!get(controller, 'reload')) {
                                set(controller, 'model.started_date', calendarView.start.format('X'));
                                controller.saveUserConfiguration();
                            }

                            // Rerender pbehaviors
                            controller.renderBehaviors();

                            // Rerender userevents
                            controller.renderUserEvents();

                            // Rerender eventlog
                            controller.renderEventLog();

                            set(controller, 'reload', false);
                        }
                    },

                    /**
                     * Describes actions to do when a user click is handled on an event
                     * @method eventClick
                     * @param {object} calEvent Event catched by the click
                     * @param {object} jsEvent Javascript event catched by the click
                     */
                    eventClick: function (calEvent, jsEvent) {
                        var controller = get(globalView, 'controller');
                        console.log('calEvent de la mort qui tue', calEvent, jsEvent);
                        controller.send('onClick' + calEvent.type, calEvent, jsEvent, globalView);
                    },

                    eventSources: [
                        {
                            events: calendarTab
                        }
                    ]
                });

                this.$().mouseup(function() {
                    globalView.$('.eventControls').stop().fadeOut(350);
                });

                set(controller, 'fullCalendarInitialized', true);

                // Sync controller and view for addEventCalendar event

                controller.on('addEventCalendar',this, this.addEventCalendar);
                controller.on('removeEventCalendar',this, this.removeEventCalendar);
                controller.on('removeUserEvent', this, this.removeUserEvent);
                controller.on('updateUserEvent', this, this.updateUserEvent);
                controller.on('willDestroyElement',this, this.willDestroyElement);
                controller.on('didInsertElement',this, this.didInsertElement);
                controller.on('viewRender',this, this.viewRender);
                controller.on('goToDate',this, this.goToDate);
                controller.on('refreshView',this, this.refreshView);


                controller.isReadyWidget('didInsertElement');
            },

            /**
             * Disable all triggered actions and destroy all view's objects
             * @method willDestroyElement
             */
            willDestroyElement: function() {
                this._super.apply(this, arguments);
                this.off('addEventCalendar',this, this.addEventCalendar);
                this.off('removeEventCalendar',this, this.removeEventCalendar);
                this.off('removeUserEvent', this, this.removeUserEvent);
                this.off('updateUserEvent', this, this.updateUserEvent);
                this.off('willDestroyElement',this, this.willDestroyElement);
                this.off('didInsertElement',this, this.didInsertElement);
                this.off('viewRender',this, this.viewRender);
                this.off('goToDate',this, this.goToDate);
                this.off('refreshView',this, this.refreshView);
                this.$('.calendar').fullCalendar('destroy');
            }
        });
        application.register('view:calendar', view);
    }
});</code></pre>
        </article>
    </section>




</div>


<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Fri Apr 15 2016 12:54:07 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
