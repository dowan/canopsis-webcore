<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/mixins/calendarsourcepbehavior.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <script src="../../doc-config.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>
<div id="main">

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Widgets</h3><ul><li><a href="widget_calendar.html"><img src="icons/application_view_gallery.png" alt="widget"/> calendar</a></li></ul><h3>Schemas</h3><ul><li><a href="schema_calendar.html"><img src="icons/table.png" alt="schema"/> calendar</a></li><li><a href="schema_calendarday.html"><img src="icons/table.png" alt="schema"/> calendarday</a></li><li><a href="schema_calendarevent.html"><img src="icons/table.png" alt="schema"/> calendarevent</a></li><li><a href="schema_calendarsourcepbehavior.html"><img src="icons/table.png" alt="schema"/> calendarsourcepbehavior</a></li><li><a href="schema_calendarsourceuserevents.html"><img src="icons/table.png" alt="schema"/> calendarsourceuserevents</a></li><li><a href="schema_eventcategories.html"><img src="icons/table.png" alt="schema"/> eventcategories</a></li></ul><h3>Adapters</h3><ul><li><a href="adapter_calendardata.html"><img src="icons/disconnect.png" alt="adapter"/> calendardata</a></li><li><a href="adapter_calendarday.html"><img src="icons/disconnect.png" alt="adapter"/> calendarday</a></li></ul><h3>Classes</h3><ul><li><a href="canopsis.frontend.brick-calendar.module_eventcategories%2520component.html">eventcategories component</a></li><li><a href="canopsis.frontend.brick-calendar.module_viewMixin.html">viewMixin</a></li></ul><h3>Mixins</h3><ul><li><a href="module-calendarsourceeventlog.html"><img src="icons/brick.png" alt="mixin"/> calendarsourceeventlog</a></li><li><a href="module-calendarsourcepbehavior.html"><img src="icons/brick.png" alt="mixin"/> calendarsourcepbehavior</a></li><li><a href="module-calendarsourceuserevents.html"><img src="icons/brick.png" alt="mixin"/> calendarsourceuserevents</a></li></ul>
</nav>


    <h1 class="page-title">Source: src/mixins/calendarsourcepbehavior.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
 * Copyright (c) 2015 "Capensis" [http://www.capensis.com]
 *
 * This file is part of Canopsis.
 *
 * Canopsis is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Canopsis is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Canopsis. If not, see &lt;http://www.gnu.org/licenses/>.
 */


Ember.Application.initializer({
    name:'CalendarsourcepbehaviorMixin',
    after: ['DataUtils'],
    initialize: function(container, application) {
        var dataUtils = container.lookupFactory('utility:data');
        var Mixin = container.lookupFactory('factory:mixin');

        var get = Ember.get,
            set = Ember.set,
            isNone = Ember.isNone,
            moment = window.moment,
            RRule = window.RRule,
            Handlebars = window.Handlebars;

        /**
         * This is the calendar source pbehavior mixin.
         * This mixin is only available for the widget calendar
         *
         * @mixin calendarsourcepbehavior
         */
        var mixin = Mixin('calendarsourcepbehavior', {
            init: function() {
                this._super();
                //get an instance of the adapter in order to use unformal adpater function
                set(this, 'pbehaviorAdapter', dataUtils.getEmberApplicationSingleton().__container__.lookup('adapter:pbehavior'));
                set(this, 'pbEvents', []);
                set(this, 'ready', false);
            },

            /**
             * Call methods after the mixins load
             * @method mixinsOptionsReady
             */
            mixinsOptionsReady: function () {
                var controller = this;
                controller._super();
                controller.loadBehaviors().then(function () {
                    set(controller, 'ready', true);
                    controller.renderBehaviors();
                });

            },

            /**
             * Rerender periodic behaviors when the calendar view is refreshed
             * @method renderBehaviors
             */
            renderBehaviors: function () {
                if (get(this, 'ready')) {

                    var controller = this;
                    var listedBehaviors = get(controller, 'model.behavior_filters');
                    if (!isNone(listedBehaviors)) {

                        for (var i = 0, lBLength = listedBehaviors.length; i &lt; lBLength; i++) {

                            // if the behavior is checked, remove the old source and load the new one
                            if(get(listedBehaviors[i], 'style') === 'fa-check-square-o') {

                                controller.removePbehavior(get(listedBehaviors[i], 'name'));
                                var pbPromises = [controller.loadPbehavior(get(listedBehaviors[i], 'name'))];
                                controller.onSourceLoad(pbPromises, ['reDrawPbehavior'], get(listedBehaviors[i], 'name'));

                            }
                        }
                    }
                }
                else {
                    return;
                }
            },

            /**
             * Synchronize selected pbehavior colors to the relatives button
             * @method pBehaviorColor
             * @return {string} background style used in the template
             */
            pBehaviorColor: function () {
                return 'background-color:' + get(this, 'bgcolor_pbehavior') + ';' + 'color:' + get(this, 'textcolor_pbehavior');
            }.property('bgcolor_pbehavior', 'textcolor_pbehavior'),

            /**
             * Remove the event source relative to the given behavior
             * @method removePbehavior
             * @param {string/object} behavior could be a string or an object containing fields relative to the event source
             */
            removePbehavior: function (behavior) {
                var controller = this;
                if (typeof behavior === 'string') {
                    var pbEvents = get(controller, 'pbEvents');
                    for (var j = 0, pbLength = pbEvents.length; j &lt; pbLength; j++) {
                        if (get(pbEvents[j], 'name') === behavior) {
                            controller.trigger('removeEventCalendar', pbEvents[j]);
                        }
                    }
                }
                else {
                    controller.trigger('removeEventCalendar', behavior);
                }
            },

            /**
             * Display on the fullcalendar an event source just loaded from database
             * @method reDrawPbehavior
             * @param {class} controller widget controller
             * @param {string/object} behavior could be a string or an object containing fields relative to the event source
             */
            reDrawPbehavior: function (controller, behavior) {
                if (typeof behavior === 'string') {
                    var pbEvents = get(controller, 'pbEvents');
                    for (var j = 0, pbLength = pbEvents.length; j &lt; pbLength; j++) {
                        if (get(pbEvents[j], 'name') === behavior) {
                            controller.trigger('addEventCalendar', pbEvents[j]);
                        }
                    }
                }
                else {
                    controller.trigger('addEventCalendar', behavior);
                }
            },

            /**
             * Load behaviors in order to display button on the calendar options and set user preferences
             * @method loadBehaviors
             */
            loadBehaviors: function () {
                var controller = this;
                var adapter = get(controller, 'pbehaviorAdapter'),
                    pbEvents = get(controller, 'pbEvents'),
                    listedBehaviors = get(controller, 'model.behavior_filters') || [];

                controller.getDateCalendarView();

                //build the params to query pbehaviors
                var PBehaviorParams = {
                    start: get(this, 'calendarStart'),
                    end: get(this, 'calendarEnd')
                };

                var promise = adapter.findCalendarPBehavior('pbehavior', PBehaviorParams).then(function (result) {
                    var pbehaviorContent = result.data;
                    var pbehaviorContentLength = pbehaviorContent.length,
                        distinctBehaviors = {};

                    // if no content, there is no pbehavior, useless to continue
                    if (pbehaviorContent.length === 0) {
                        return;
                    }

                    for (var i = 0; i &lt; pbehaviorContentLength; i++) {
                        var behaviors = get(pbehaviorContent[i], 'behaviors');
                        var lBehavior = behaviors.length;

                        // get all distinct behaviors
                        for (var j = 0; j &lt; lBehavior; j++){
                            distinctBehaviors[behaviors[j]] = true;
                        }
                    }

                    var userPreferences = [];
                    for (var k=0, length = listedBehaviors.length; k &lt; length; k++) {
                        var listedBehavior = listedBehaviors[k];
                        var name = get(listedBehavior, 'name');

                        userPreferences[name] = get(listedBehavior, 'style');
                    }

                    var behaviorsTab = Object.keys(distinctBehaviors);
                    var behaviorsObjects = [];
                    for (var l = 0, behaviorsTabLength = behaviorsTab.length; l &lt; behaviorsTabLength; l++) {
                        pbEvents.pushObject({
                            name: behaviorsTab[l],
                            events: [],
                            color: get(controller, 'bgcolor_pbehavior'),
                            textColor: get(controller, 'textcolor_pbehavior')
                        });

                        var style = userPreferences[behaviorsTab[l]] || 'fa-square-o';

                        behaviorsObjects.pushObject({
                            name: behaviorsTab[l],
                            style: style
                        });
                    }
                    set(controller, 'model.behavior_filters', behaviorsObjects);
                    controller.saveUserConfiguration();
                    set(controller, 'pbEvents', pbEvents);
                });

                return promise;
            },

            /**
             * Get pbehavior relative to the given behavior from default_pbehavior collection
             * @method loadPbehavior
             * @param {string/object} behavior could be a string or an object containing fields relative to the event source
             * @return {promise}
             */
            loadPbehavior: function (behavior) {
                var controller = this;
                var adapter = get(controller, 'pbehaviorAdapter'),
                    pbEvents = get(controller, 'pbEvents');

                controller.getDateCalendarView();
                //build the params to query pbehaviors
                var PBehaviorParams = {
                    start: get(this, 'calendarStart'),
                    end: get(this, 'calendarEnd'),
                    behaviors: behavior
                };

                //query pbehaviors with params
                var promise = adapter.findCalendarPBehavior('pbehavior', PBehaviorParams).then(function (result) {
                    var pbehaviorContent = result.data;
                    var pbehaviorContentLength = pbehaviorContent.length,
                        calendarTab = [];

                    if (pbehaviorContent.length === 0){
                        return;
                    }
                    for (var i = 0; i &lt; pbehaviorContentLength; i++) {

                        var behaviors = get(pbehaviorContent[i], 'behaviors');

                        // get rrule, dtstart return if no rrule
                        var rule = controller.getDatesFromRrule(
                            get(pbehaviorContent[i], 'rrule'),
                            get(pbehaviorContent[i], 'dtstart')
                        );

                        // get duration
                        var duration = get(pbehaviorContent[i], 'dtend') -
                                       get(pbehaviorContent[i], 'dtstart');

                        for (var k = 0, ruleLength = rule.length; k &lt; ruleLength; k++) {
                            // get fullcalendar formated event for every rrule occurence
                            var formated_eventPBehavior = controller.getPBehavior(
                                rule[k],
                                duration,
                                get(pbehaviorContent[i], 'source'),
                                behaviors.join(' - ')
                            );
                            calendarTab.pushObject(formated_eventPBehavior);
                        }
                    }

                    // finally we add the formated events to the global object
                    for (var l = 0,lbLength = pbEvents.length; l &lt; lbLength; l++) {
                        if (pbEvents[l].name === behavior) {
                            pbEvents[l].events = calendarTab;
                        }
                    }
                    console.log('pbEvents', pbEvents);
                    set(controller, 'pbEvents', pbEvents);
                });

                return promise;
            },

            /**
             * Get a list of dates relatives to a given rrule
             * if no rrule, it is a list of one date
             * @method getDatesFromRrule
             * @param {string} rrule
             * @param {number} dtstart
             * @return {array}
             */
            getDatesFromRrule: function(rrule, dtstart){
                var ruletest,
                    result = [];

                if (isNone(rrule)) {
                    result.pushObject(moment(dtstart*1000).format());
                }
                else {
                    ruletest = RRule.fromString(rrule);
                    var eventRuleList = ruletest.between(
                        new Date(get(this, 'calendarStart')*1000),
                        new Date(get(this, 'calendarEnd')*1000)
                    );
                    var eventRuleListLength = eventRuleList.length;
                    for (var k = 0; k &lt; eventRuleListLength; k++) {
                        result.pushObject(moment(eventRuleList[k]).format());
                    }
                }

                return result;
            },

            /**
             * Format pbehaviors for fullcalendar
             * @method getPBehavior
             * @param {number} eventStart Number pbehavior's beginning
             * @param {number} duration Number pbehavior's duration
             * @param {string} source String component's name concern by the pbehavior
             * @param {string} behavior String of behavior(s)
             */
            getPBehavior: function(eventStart, duration, source, behavior) {
                var controller = this;
                var dtstart = eventStart;
                var dtend = parseInt(moment(eventStart).format('X')) + duration;
                dtend = moment(dtend*1000).format();

                var templateContext = [Ember.Object.create({
                    begin: eventStart,
                    end: dtend,
                    behavior: behavior,
                    component: source
                })];

                var html;
                var template = get(controller, 'mixinOptions.calendarsourcepbehavior.event_title') || '';
                try {
                    html = Handlebars.compile(template)(templateContext[0].toJson());
                } catch (err) {
                    html = '&lt;i>An error occured while compiling the template with the record. please if check the template is correct&lt;/i>';
                }

                return {
                    type: 'pbehavior',
                    title: new Ember.Handlebars.SafeString(html),
                    start: dtstart,
                    end: dtend,
                    behavior: behavior,
                    component: source
                };
            },

            actions:{

                /**
                 * Display the recordinfopopup relative to the selected event
                 * @method onClickpbehavior
                 * @param {object} calEvent selected fullcalendar event
                 * @param {object} jsEvent Javascript catched event
                 */
                onClickpbehavior: function (calEvent, jsEvent) {
                    void(jsEvent);
                    var controller = this;

                    // object that contains information usable in the recordinfopopup mixin
                    var templateContext = Ember.Object.create({
                        begin: calEvent.start.format('MMMM Do YYYY, h:mm:ss a'),
                        end: calEvent.end.format('MMMM Do YYYY, h:mm:ss a'),
                        behavior: calEvent.behavior,
                        component: calEvent.component
                    });

                    var recordinfopopupController = get(controller, 'controllers.recordinfopopup');
                    recordinfopopupController.send(
                        'show',
                        [templateContext],
                        get(controller, 'mixinOptions.calendarsourcepbehavior.popup_template') || ''
                    );
                },


                /**
                 * Show/hide pbehaviors in the calendar
                 * @method showPbehavior
                 * @param {object} behavior selected behavior
                 */
                showBehavior: function (behavior) {
                    var controller = this;
                    var listedBehaviors = get(controller, 'model.behavior_filters'),
                        pbEvents = get(controller, 'pbEvents');
                    if (isNone(listedBehaviors)) {
                        listedBehaviors = [];
                    }

                    for (var i = 0, lbLength = listedBehaviors.length; i &lt; lbLength; i++) {
                        if (listedBehaviors[i].name === behavior.name) {
                            // update userprefs
                            var style = listedBehaviors[i].style === 'fa-square-o' ? 'fa-check-square-o': 'fa-square-o';
                            set(listedBehaviors[i], 'style', style);
                            set(controller, 'model.behavior_filters', listedBehaviors);
                            controller.saveUserConfiguration();

                            // if unchecked button, remove relative events
                            if(style === 'fa-square-o') {
                                for (var j = 0, pbELength = pbEvents.length; j &lt; pbELength; j++) {
                                    if (pbEvents[j].name === behavior.name) {
                                        controller.removePbehavior(pbEvents[j]);
                                        pbEvents[j].events = [];
                                    }
                                }
                            }
                            // if checked button add relative events
                            else {
                                for (var k = 0, pbLength = pbEvents.length; k &lt; pbLength; k++) {
                                    if (pbEvents[k].name === behavior.name) {
                                        var promises = [controller.loadPbehavior(behavior.name)];
                                        controller.onSourceLoad(promises, ['reDrawPbehavior'], pbEvents[k]);
                                    }
                                }
                            }
                        }
                    }
                    set(controller, 'pbEvents', pbEvents);
                }
            }
        });

        application.register('mixin:calendarsourcepbehavior', mixin);
    }
});</code></pre>
        </article>
    </section>




</div>


<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Fri Apr 15 2016 12:54:07 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
