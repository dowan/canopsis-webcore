Ember.Application.initializer({name:"component-ack",after:"DatesUtils",initialize:function(e,t){var n=e.lookupFactory("utility:dates"),o=Ember.get,i=Ember.set,r=Ember.isNone,s=Ember.String.loc,a=Ember.Component.extend({crecord:void 0,value:void 0,tickettooltip:void 0,acktooltip:void 0,ackcolor:void 0,acktitle:void 0,init:function(){this._super();var e=o(this,"crecord"),t=o(this,"value");console.log("Ack crecord",e,"Ack value",t);var a=o(e,"record.ticket_declared_author"),c=o(e,"record.ticket_declared_date"),l=o(e,"record.ticket"),u=o(e,"record.ticket_date"),d="";r(l)||r(u)||(d=["<b>"+s("Ticket number")+"</b><br/>",n.timestamp2String(u)+" <br/> ","<i>"+l+"</i><br/> "].join(""));var f="";r(c)||r(a)?r(l)||r(u)||(console.debug("ticket date is ",o(e,"record.ticket_date")),f=["<center>",d,"</center>"].join(""),i(this,"tickettooltip",f)):(f=["<center>","<b>"+s("Ticket declared")+"</b><br/>",n.timestamp2String(c)+" <br/> ",s("By")+" : "+a+" <br/><br/> ",d,"</center>"].join(""),i(this,"tickettooltip",f));var p=t&&t.timestamp?n.timestamp2String(t.timestamp):"",h=t&&t.author?t.author:"",m=t&&t.comment?t.comment:"",g=["<center>","<b>"+s("Ack")+"</b><br/>","<i>"+s("Date")+"</i> : <br/>",p+" <br/> ",s("By")+" : "+h+" <br/><br/> ","<i>"+s("Comment")+" </i> : <br/>"+m,"</center>"].join("");console.log("ack value",t),i(this,"acktooltip",g),t&&t.isCancel?(i(this,"ackcolor",""),i(this,"acktitle",s("Cancelled"))):(i(this,"ackcolor","bg-purple"),i(this,"acktitle",s("Acknowleged")))}});t.register("component:component-ack",a)}}),Ember.Application.initializer({name:"component-cfiltereditor",after:"IndexesRegistry",initialize:function(e,t){var n={},o=e.lookupFactory("registry:indexes"),i=Ember.get,r=Ember.set,s=Ember.isNone,a=Ember.Component.extend({init:function(){var e=i(this,"cfilter_serialized");r(this,"onlyAllowRegisteredIndexes",i(n,"conf.frontendConfig.cfilter_allow_only_optimized_filters")),null!==i(this,"content")&&void 0!==i(this,"content")?r(this,"cfilter_serialized",i(this,"content")):(void 0===e||null===e)&&r(this,"cfilter_serialized","{}"),this._super.apply(this,arguments)},indexesTree:{component:{_metas:{name:"Component"},resource:{_metas:{name:"Resource","final":!0}}},connector:{_metas:{name:"connector"},component:{_metas:{name:"Component"},resource:{_metas:{name:"Resource","final":!0}}}}},currentClauseIndex:-1,cfilter_serialized:Ember.computed.alias("content"),viewTabColumns:[{name:"component",title:"component"},{name:"resource",title:"resource"}],indexes:o,selectedIndexName:"event",selectedIndexChanged:function(){for(var e=i(this,"selectedIndexName"),t=i(this,"indexes"),n=0,o=t.all.length;o>n;n++){var s=t.all[n];s.name===e&&r(this,"indexesTree",s.tree)}}.observes("selectedIndexName"),clauses:function(){var e,t=i(this,"cfilter_serialized"),n=Ember.A();try{e=JSON.parse(t)}catch(o){console.error("unable to parse serialized filter"),e={$or:{}}}if(console.log("deserializeCfilter",t,n.length),console.log("mfilter",e),void 0===e.$or&&0!==Object.keys(e).length)return console.error("This editor cannot display the current filter"),r(this,"filterError","This editor cannot display the current filter"),n;if(void 0===e.$or)return n;for(var s=0,a=e.$or.length;a>s;s++){var c=e.$or[s],l=Ember.Object.create({and:Ember.A()});if(void 0===c.$and&&void 0!==Ember.keys(c)[0]&&(c.$and=[c]),void 0!==c.$and){for(var u,d=0,f=c.$and.length;f>d;d++){var p=c.$and[d],h=Ember.keys(p)[0],m=Ember.keys(p[h])[0];console.log(p[h][m]);var g=p[h][m];"not in"!==m&&"in"!==m||"object"!=typeof g||(g=g.join(","));var v=this.getIndexesForNewAndClause(l),b={isFirst:0===d,keyId:i(this,"cfilterEditId")+"-keys-"+(d+1),options:{available_indexes:v},key:h,value:g,operator:this.getLabelForMongoOperator(m),lastOfList:!0,filling:!1,finalized:!0};u=Ember.Object.create(b),console.log("field:",u),l.and.pushObject(u)}var y=i(this,"onlyAllowRegisteredIndexes")===!0;(!y||i(u,"options.available_indexes.length")>0)&&(console.log("append empty and clause"),this.pushEmptyClause(l)),n.pushObject(l)}i(this,"onlyAllowRegisteredIndexes")===!1&&this.pushEmptyClause(l)}return console.log("clause deserialized",n),n}.property(),classNames:["cfilter"],operators:[{label:"=",value:"$eq"},{label:"!=",value:"$ne"},{label:"<",value:"$lt"},{label:">",value:"$gt"},{label:"in",value:"$in"},{label:"not in",value:"$nin"},{label:"regex",value:"$regex"},{label:"!regex",value:"$not"}],orButtonHidden:!1,onlyAllowRegisteredIndexes:!0,serializeCfilter:function(){for(var e=i(this,"clauses"),t={$or:[]},n=0,o=e.length;o>n;n++){var a=e[n],c={$and:[]};void 0!==a.and[0]&&r(a.and[0],"isFirst",!0);for(var l=0,u=a.and.length;u>l;l++){var d=a.and[l];if(0===l?r(d,"isFirst",!0):r(d,"isFirst",!1),r(d,"finalized",!0),l===a.and.length-1?r(a.and[l],"isLast",!0):r(a.and[l],"isLast",!1),Ember.isArray(a.and[l].value)||"in"!==a.and[l].operator&&"not in"!==a.and[l].operator?"string"==typeof a.and[l].value&&$.isNumeric(a.and[l].value)&&(a.and[l].value=parseFloat(a.and[l].value)):(console.log("Operator in detected"),a.and[l].value=a.and[l].value.split(",")),void 0!==d.key){var f={};console.log("field",d);var p={label:"=",value:"$eq"};void 0!==d.operator&&(p=this.getMongoOperatorForLabel(d.operator)),s(p.format)&&(p.format=function(e){return e}),f[d.key]={},f[d.key][p.value]=p.format(d.value),c.$and.pushObject(f)}}c.$and.length>0&&(1===c.$and.length&&(c=c.$and[0]),t.$or.pushObject(c))}return 0===t.$or.length&&(t={}),t=JSON.stringify(t,null,"")},getMongoOperatorForLabel:function(e){for(var t=0,n=this.operators.length;n>t;t++)if(this.operators[t].label===e)return this.operators[t]},getLabelForMongoOperator:function(e){for(var t=0,n=this.operators.length;n>t;t++)if(this.operators[t].value===e)return this.operators[t].label},checkIfNewAndClauseDisplayed:function(){var e=i(this,"currentClauseIndex");if(e>=0){var t=i(this,"clauses"),n=t.objectAt(e),o=n.and[n.and.length-1],s=function(e){return void 0===e||""===e?!0:!1};return void 0!==o&&s(o.key)&&s(o.value)?void r(this,"newAndClauseDisplayed",!1):void r(this,"newAndClauseDisplayed",!0)}return void r(this,"newAndClauseDisplayed",!1)}.observes("currentClauseIndex"),clausesChanged:function(){var e=i(this,"clauses");if(console.log("clausesChanged",e,e.length),0===e.length)r(this,"orButtonHidden",!1);else{var t=e[e.length-1];console.log("last and length",e),console.log("last and length",t),console.log("last and length",t.and.length);var n=t.and[t.and.length-1];console.log("lastAndQueryPart",n,n.key),t.and.length<=1&&(Ember.isNone(n.key)||Ember.isNone(n.value))?r(this,"orButtonHidden",!0):r(this,"orButtonHidden",!1)}var o=this.serializeCfilter();console.log("generated mfilter",o),r(this,"cfilter_serialized",o)},cfilterId:function(){return i(this,"elementId")+"-cfilter"}.property("elementId"),cfilter:function(){return $("#"+i(this,"cfilterId"))},cfilterEditId:function(){return i(this,"cfilterId")+"-edit"}.property("cfilterId"),cfilterEditTabId:function(){return"#"+i(this,"cfilterEditId")}.property("cfilterEditId"),cfilterEdit:function(){return $(i(this,"cfilterEditTabId"))},cfilterRawId:function(){return i(this,"cfilterId")+"-raw"}.property("cfilterId"),cfilterRawTabId:function(){return"#"+i(this,"cfilterRawId")}.property("cfilterRawId"),cfilterRaw:function(){return $(i(this,"cfilterRawTabId"))},cfilterViewId:function(){return i(this,"cfilterId")+"-view"}.property("cfilterId"),cfilterViewTabId:function(){return"#"+i(this,"cfilterViewId")}.property("cfilterViewId"),cfilterView:function(){return $(i(this,"cfilterViewTabId"))},getIndexesForNewAndClause:function(e){if(console.group("getIndexesForNewAndClause useIndexesOptions : ",i(this,"onlyAllowRegisteredIndexes"),e),i(this,"onlyAllowRegisteredIndexes")===!0){console.group("getIndexesForNewAndClause",e);for(var t=i(this,"indexesTree"),n=0,o=e.and.length;o>n;n++){var r=e.and[n];console.log("currentAnd",r),void 0===t?console.error("bad index management",r.key):t=t[r.key],console.log("indexesTreeCursor",t)}console.info("available indexes",t);var s=[];for(var a in t)console.log("iter",a,t[a]),"_metas"!==a&&s.pushObject({name:t[a]._metas.name,value:a,_metas:t[a]._metas});return console.groupEnd(),s}console.log('no index available because "use indexes" option is disabled'),console.groupEnd()},pushEmptyClause:function(e){console.group("pushEmptyAndClause",i(this,"onlyAllowRegisteredIndexes"));var t=this.getIndexesForNewAndClause(e),n=i(this,"onlyAllowRegisteredIndexes")===!0;console.log("available_indexes",t);var o={keyId:i(this,"cfilterEditId")+"-keys-"+(e.and.length+1),options:{available_indexes:t},key:void 0,value:void 0,operator:"=",lastOfList:!0,filling:!1,finalized:!1},s=e.and[e.and.length-2];console.log("and array",e.and),console.log("lastAndClauseOfList",s),void 0!==s&&r(s,"lastOfList",!1),(!n||i(o,"options.available_indexes.length")>0)&&e.and.pushObject(Ember.Object.create(o)),console.groupEnd("pushEmptyClause")},actions:{selectIndexByName:function(e){r(this,"selectedIndexName",e)},unlockIndexes:function(){r(this,"onlyAllowRegisteredIndexes",!1)},lockIndexes:function(){r(this,"onlyAllowRegisteredIndexes",!0)},addAndClause:function(e){console.log("Add AND clause");var t=this.get("clauses"),n=this.get("currentClauseIndex");console.log(n);var o=t.objectAt(n);if(Ember.isNone(o)&&console.error("currentClause seems empty"),n>=0){var s=i(this,"onlyAllowRegisteredIndexes");console.log("test if it's possible to add a and clause",s,!e),(s||!e)&&(console.log("try to push empty and clause"),this.pushEmptyClause(o))}console.log("clauses addAndClause",t),r(this,"clauses",t),this.clausesChanged()},addOrClause:function(){var e=i(this,"clauses");console.group("Add OR clause",e);var t,n=i(this,"currentClauseIndex");n>=0&&(t=e.objectAt(n),r(t,"current",!1)),t=e.pushObject(Ember.Object.create({current:!0,and:[]})),r(this,"currentClauseIndex",e.length-1),console.log("calling addAndClause"),this.send("addAndClause"),this.send("activate",t),console.groupEnd()},activate:function(e){var t=i(this,"clauses"),n=i(this,"currentClauseIndex"),o=t.indexOf(e);n!==o&&(console.log("Activate clause:",e),n>=0&&t.objectAt(n).set("current",!1),r(e,"current",!0),console.log("changing currentClauseIndex"),r(this,"currentClauseIndex",o))},removeAndClause:function(e,t){console.log("removeAndClause");for(var n,o=i(this,"clauses"),s=!1,a=0;a<e.and.length;a++){var c=e.and.objectAt(a);if(console.log("currentAnd",c),s===!0&&(e.and.removeAt(a),a--),c===t){e.and.removeAt(a),console.log("processing delete",e.and,e.and.objectAt(a-1));var l=e.and.objectAt(a-1);if(void 0!==l&&r(l,"lastOfList",!0),a--,i(this,"onlyAllowRegisteredIndexes")===!0&&(s=!0,-1===a)){console.log("the clause will be empty, drop it and quit");for(var u=e,d=0,f=o.length;f>d;d++)if(n=o[d],n===u)return o.removeAt(d),i(this,"currentClauseIndex")>=d&&r(this,"currentClauseIndex",i(this,"currentClauseIndex")-1),void this.clausesChanged()}}}void 0!==e&&i(this,"onlyAllowRegisteredIndexes")===!0&&this.pushEmptyClause(e),this.clausesChanged()}}});t.register("component:component-cfiltereditor",a)}}),Ember.Application.initializer({name:"component-eventselector",initialize:function(e,t){var n=Ember.get,o=Ember.set,i=Ember.isNone,r=Ember.String.loc,s=Ember.Component.extend({init:function(){this._super(),this.set("componentDataStore",DS.Store.create({container:this.get("container")})),console.log("Event selector init"),this.set("selectedEvents",[]),o(this,"search_resource",r("Search for a resource")),o(this,"search_component",r("Search for a component")),o(this,"type_label",r("Associate a label to this event")),void 0!==n(this,"content")&&this.initializeEvents()},initializeEvents:function(){var e=[],t={};if(n(this,"labelled"))for(var i=n(this,"content"),r=i.length,s=0;r>s;s++)e.push(i[s].rk),t[i[s].rk]=i[s].label;else e=n(this,"content");var a=this;n(this,"componentDataStore").findQuery("event",{filter:JSON.stringify({_id:{$in:e}}),limit:0}).then(function(e){if(console.log("Fetched initialization data from events",e.content),n(a,"labelled"))for(var i=e.content.length,r=0;i>r;r++){var s=n(e.content[r],"id");o(e.content[r],"label",t[s])}o(a,"selectedEvents",e.content)})},findEvents:function(){var e={},t=this.getSelectedRks();if(t.length&&(e._id={$nin:t}),this.get("component")&&(e.component={$regex:".*"+this.get("component")+".*",$options:"i"}),this.get("resource")&&(e.resource={$regex:".*"+this.get("resource")+".*",$options:"i"}),e.event_type="check",this.get("selectors")&&(e.event_type={$in:["selector","sla"]}),this.get("topologies")&&(e.source_type={$eq:"topo"}),e.resource||e.component||(this.set("events",[]),this.get("topologies")||this.get("selectors"))){var o=n(this,"componentDataStore").findQuery("event",{filter:JSON.stringify(e),limit:10}),i=this;o.then(function(e){console.log("Fetched data from events",e.content),i.set("events",e.content)})}}.observes("component","resource"),setSelector:function(){this.set("topologies",!1),this.findEvents()}.observes("selectors"),setTopologies:function(){this.set("selectors",!1),this.findEvents()}.observes("topologies"),getSelectedRks:function(){var e=[],t=n(this,"labelled"),o=n(this,"selectedEvents");if(!i(o))for(var r=o.length,s=0;r>s;s++)if(t){var a=n(o[s],"label");a=i(a)?"default_"+s:a.trim(),e.push({rk:n(o[s],"id"),label:a})}else e.push(n(o[s],"id"));return e},actions:{saveLabels:function(){o(this,"content",this.getSelectedRks()),o(this,"saveLabelsDone",!0);var e=this;setTimeout(function(){o(e,"saveLabelsDone",!1)},3e3)},add:function(e){console.log("Adding event",e),n(this,"selectedEvents").pushObject(e),n(this,"events").removeObject(e),o(this,"content",this.getSelectedRks()),0===n(this,"events").length&&this.findEvents()},"delete":function(e){console.log("Rk to delete",e.id),n(this,"selectedEvents").removeObject(e),this.findEvents(),o(this,"content",this.getSelectedRks())}}});t.register("component:component-eventselector",s)}}),Ember.Application.initializer({name:"component-stateeditor",initialize:function(e,t){var n=Ember.get,o=Ember.set,i=Ember.isNone,r=Ember.Component.extend({previousContent:void 0,content:void 0,init:function(){this._super(),o(this,"previousContent",n(this,"content")),i(n(this,"hidePrevious"))&&o(this,"hidePrevious",!0)},isInfo:function(){return 0===n(this,"content")}.property("content"),isMinor:function(){return 1===n(this,"content")}.property("content"),isMajor:function(){return 2===n(this,"content")}.property("content"),isCritical:function(){return 3===n(this,"content")}.property("content"),previousIs:function(e){return n(this,"showAll")?!1:n(this,"hidePrevious")&&n(this,"previousContent")===e},previousIsInfo:function(){return this.previousIs(0)}.property("previousContent"),previousIsMinor:function(){return this.previousIs(1)}.property("previousContent"),previousIsMajor:function(){return this.previousIs(2)}.property("previousContent"),previousIsCritical:function(){return this.previousIs(3)}.property("previousContent"),actions:{setState:function(e){o(this,"content",parseInt(e))}}});t.register("component:component-stateeditor",r)}}),Ember.Application.initializer({name:"component-statemapping",initialize:function(e,t){var n=Ember.get,o=Ember.set,i=Ember.isNone,r=Ember.String.loc,s=Ember.Component.extend({placeholder:r("write template"),didInsertElement:function(){var e=n(this,"content"),t=n(this,"initialized");i(t)&&!i(e)&&Ember.setProperties(this,{info:e.info,minor:e.minor,major:e.major,critical:e.critical,initialized:!0})}.observes("content"),updateContent:function(){var e={info:n(this,"info"),minor:n(this,"minor"),major:n(this,"major"),critical:n(this,"critical")};console.log("statemapping",e),o(this,"content",e)}.observes("critical","major","minor","info")});t.register("component:component-statemapping",s)}}),Ember.Application.initializer({name:"AckForm",after:["FormFactory","ModelForm"],initialize:function(e,t){var n=e.lookupFactory("factory:form"),o=e.lookupFactory("form:modelform"),i={subclass:o},r=n("ackform",{init:function(){this._super(),Ember.set(this,"partials.buttons",["formbutton-cancel","formbutton-ack","formbutton-ackandproblem"])}},i);t.register("form:ackform",r),Ember.TEMPLATES.ackform=Ember.TEMPLATES.modelform}}),Ember.Application.initializer({name:"TicketForm",after:["FormFactory","ModelForm"],initialize:function(e,t){var n=e.lookupFactory("factory:form"),o=e.lookupFactory("form:modelform"),i={subclass:o},r=n("ticketform",{init:function(){this._super(),this.set("partials.buttons",["formbutton-cancel","formbutton-incident"])}},i);t.register("form:ticketform",r),Ember.TEMPLATES.ticketform=Ember.TEMPLATES.modelform}}),Ember.Handlebars.helper("criticity",function(e,t){var n=Ember.String.loc;console.log("keep_state",t);var o="";if(void 0===e&&(e=4),t){var i="";switch(e){case 0:i="bg-green";break;case 1:i="bg-yellow";break;case 2:i="bg-orange";break;case 3:i="bg-red"}o='<span class="badge '+i+'"><i class="fa fa-male"></i></span>'}var r;switch(e){case 0:r='<span class="badge bg-green">'+n("Info")+"</span>";break;case 1:r='<span class="badge bg-yellow">'+n("Minor")+"</span>";break;case 2:r='<span class="badge bg-orange">'+n("Major")+"</span>";break;case 3:r='<span class="badge bg-red">'+n("Critical")+"</span>";break;case 4:r='<span class="badge">'+n("Unknown")+"</span>"}return r+o}),Ember.Handlebars.helper("recordcanbeack",function(e){console.debug("in recordcanbeack. record status is",Ember.get(e,"status"));var t=0!==Ember.get(e,"status")&&2!==Ember.get(e,"status");return Ember.set(e,"recordcanbeack",t),""}),Ember.Handlebars.helper("stateview",function(e){var t=Ember.String.loc,n={0:{color:"green",text:"Info"},1:{color:"yellow",text:"Minor"},2:{color:"orange",text:"Major"},3:{color:"red",text:"Critical"}},o=n[e],i='<span class="badge bg-%@">%@</span>'.fmt(o.color,t(o.text));return new Ember.Handlebars.SafeString(i)}),Ember.Application.initializer({name:"StatusViewHelper",after:"DatesUtils",initialize:function(e,t){var n=e.lookupFactory("utility:dates"),o=Ember.get,i=Ember.set,r=Ember.isNone,s=Ember.String.loc;Ember.Handlebars.helper("statusview",function(e,t){var a={0:"Off",1:"On going",2:"Stealthy",3:"Bagot",4:"Cancelled"};r(e)&&(e=o(t,"status"));var c=a[e]||"";if(i(t,"statusvalue",s(c)),4===e){var l=o(t,"record.cancel");if(console.log("statusview",e,l),!r(l)){var u=o(l,"timestamp"),d=o(l,"comment"),f=o(l,"author");i(t,"statushtml",["<center>","<i>",s("Date"),"</i> : <br/>",n.timestamp2String(u)," <br/> ",s("By")," : ",f," <br/><br/> ","<i>",s("Comment"),"</i> : <br/>",d,"</center>"].join(""))}}return""})}}),Ember.Application.initializer({name:"EditurlfieldMixin",after:["FormsUtils","MixinFactory"],initialize:function(e,t){var n=e.lookupFactory("factory:mixin"),o=e.lookupFactory("utility:forms"),i=Ember.get,r=n("editurlfield",{partials:{actionToolbarButtons:["actionbutton-editurlfield"]},actions:{editUrlField:function(){o.editSchemaRecord("linklistfieldsurl",i(this,"container"))}}});t.register("mixin:editurlfield",r)}}),Ember.Application.initializer({name:"EventhistoryMixin",after:["MixinFactory","FormsUtils","HashUtils"],initialize:function(e,t){var n=e.lookupFactory("factory:mixin"),o=n("eventhistory",{partials:{actionToolbarButtons:["actionbutton-eventnavigation"]}});t.register("mixin:eventhistory",o)}}),Ember.Application.initializer({name:"EventnavigationMixin",after:["MixinFactory","FormsUtils","HashUtils"],initialize:function(e,t){var n=e.lookupFactory("factory:mixin"),o=n("eventnavigation",{partials:{actionToolbarButtons:["actionbutton-history"]}});t.register("mixin:eventnavigation",o)}}),Ember.Application.initializer({name:"HistoryMixin",after:"MixinFactory",initialize:function(e,t){var n=e.lookupFactory("factory:mixin"),o=n("history",{historyMixinFindOptions:function(){console.warn("this should be overriden")}.property(),isHistory:function(){return this.get("historyMixinFindOptions")},actions:{history:function(){this.set("historyMixinFindOptions",!this.get("historyMixinFindOptions")),this.findItems()}}});t.register("mixin:history",o)}}),Ember.Application.initializer({name:"InfobuttonMixin",after:"MixinFactory",initialize:function(e,t){var n=e.lookupFactory("factory:mixin"),o=n("infobutton",{partials:{itemactionbuttons:["actionbutton-info"]}});t.register("mixin:infobutton",o)}}),Ember.Application.initializer({name:"RecordinfopopupMixin",after:"MixinFactory",initialize:function(e,t){var n=e.lookupFactory("factory:mixin"),o=Ember.get,i=n("recordinfopopup",{actions:{sendDisplayRecord:function(e){console.log("sendDisplayRecord action called with params",e);var t=o(this,"mixinOptions.recordinfopopup.popup_template");Ember.isNone(t)&&(t=""),console.log("Template is ",t);var n=o(this,"controllers.recordinfopopup");n.send("show",e,t)}},rendererFor:function(e){var t=o(this,"mixinOptions.recordinfopopup.clickable_column");return console.log("recordinfopopup rendererFor",e,t),e.field===t?"renderer-recordinfopopup":this._super(e)}});t.register("mixin:recordinfopopup",i)}}),Ember.Application.initializer({name:"SendeventMixin",after:["MixinFactory","FormsUtils","DatesUtils","NotificationUtils"],initialize:function(e,t){var n=e.lookupFactory("factory:mixin"),o=e.lookupFactory("utility:forms"),i=e.lookupFactory("utility:dates"),r=e.lookupFactory("utility:notification"),s=Ember.get,a=Ember.set,c=Ember.isNone,l=Ember.String.loc,u=n("sendevent",{needs:["application"],init:function(){this._super(),a(this,"login",s(this,"controllers.login.record"))},partials:{itemactionbuttons:["actionbutton-ack","actionbutton-cancel","actionbutton-incident","actionbutton-changestate","actionbutton-ticketnumber"],selectionToolbarButtons:["actionbutton-cancelselection","actionbutton-ackselection"]},setPendingOperation:function(e){var t=s(this,"controllers.application.frontendConfig.safe_mode");if(t)for(var n=0,o=e.length;o>n;n++)console.log("Pending operations on crecord",e[n]),e[n].set("pendingOperation",!0)},getDataFromRecord:function(e,t,n){console.group("getDataFromRecord"),console.log("get data from record:",e,n);for(var o={authkey:s(this,"login.authkey"),author:s(this,"login._id"),id:s(t,"id"),connector:s(t,"connector"),connector_name:s(t,"connector_name"),event_type:e,source_type:s(t,"source_type"),component:s(t,"component"),state:s(t,"state"),state_type:s(t,"state_type"),crecord_type:e,timestamp:i.getNow()},r=["domain","perimeter","resource"],l=0,u=r.length;u>l;l++){var d=r[l];c(s(t,d))||a(o,d,s(t,d))}return"resource"===o.source_type&&(o.resource=s(t,"resource")),this.processEvent(e,"extract",[o,t,n]),console.groupEnd(),o},submitEvents:function(e,t,n){var o=this,i=this.get("controllers.application.frontendConfig.safe_mode");return console.log("safe_mode",i),new Ember.RSVP.Promise(function(r,a){for(var c=[],l=0;l<e.length;l++){console.log("Event:",s(t,"author"),s(t,"output"));var u=o.getDataFromRecord(n,e[l],t);u.author=s(t,"author"),u.output=s(t,"output"),s(t,"ticket")&&(u.ticket=s(t,"ticket")),c.push(u),i||o.processEvent(n,"transform",[e[l],u])}$.post("/event",{event:JSON.stringify(c)}).then(function(e){Ember.run(function(){t.rollback(),t.unloadRecord(),console.log("safe_mode",i),i?o.refreshContent():o.trigger("refresh"),r(arguments)})})})},getEventForm:function(e,t,n,i){i=i||"modelform";var a=o.showNew(i,t,{title:l("Add event type: ")+e,override_labels:{output:"comment"},onePageDisplay:!0}),c=this,u=function(){c.startRefresh(),t.rollback(),t.unloadRecord()};a.submit.then(function(o){console.log("saveRecord:",t,o),t=s(o,"formContext"),r.info(l("event sent: ")+e),c.submitEvents(n,t,e),-1!==$.inArray("reportIncident",arguments[1])&&c.submitEvents(n,t,"declareticket"),u()},u)},getRoutingKey:function(e){var t=[e.connector,e.connector_name,e.event_type,e.source_type,e.component].join(".");return"resource"===e.source_type&&(t=[e.id,e.resource].join(".")),t},getDisplayRecord:function(e,t){var n=s(this,"widgetDataStore"),o=this.getDataFromRecord(e,t),i=n.createRecord(e,o);return i},filterUsableCrecords:function(e,t){for(var n=[],o=0,i=t.length;i>o;o++){var r=t[o],s=this.processEvent(e,"filter",[r]);s&&n.pushObject(r)}return n},event_processors:{ack:{extract:function(e,t,n){e.ref_rk=s(t,"id"),e.state=0,e.state_type=1,e.id=this.getRoutingKey(e),void 0!==n&&(e.ticket=s(n,"ticket"),e.output=s(n,"output"))},filter:function(e){var t=3,n=0;return s(e,"state")&&!s(e,"ack.isAck")&&!s(e,"ack.isCancel")||s(e,"state")===n&&s(e,"status")===t},handle:function(e){var t=this.getDisplayRecord("ack",e[0]);this.getEventForm("ack",t,e,"ackform")},transform:function(e,t){console.log("transform method for ack -> crecords",e,"record",t),e.set("ack",{comment:t.output,timestamp:i.getNow(),author:t.author,isAck:!0}),c(t.ticket)||(e.set("ticket",t.ticket),e.set("ticket_date",i.getNow())),e.set("ack_remove",void 0)}},ackremove:{extract:function(e,t,n){c(n)||(e.output=s(n,"output")),e.ref_rk=s(t,"id"),e.state=0,e.state_type=1,e.id=this.getRoutingKey(e)},filter:function(e){return s(e,"ack.author")&&s(e,"ack.isAck")},handle:function(e){var t=this.getDisplayRecord("ackremove",e[0]);this.getEventForm("ackremove",t,e)},transform:function(e,t){console.log("transform method for ack remove",e,t),e.set("ack",void 0),e.set("declare_ticket_author",void 0),e.set("declare_ticket_date",void 0),e.set("ticket",void 0),e.set("ticket_date",void 0),e.set("ack_remove",Ember.Object.create({comment:t.output,timestamp:i.getNow(),author:t.author}))}},declareticket:{extract:function(e,t,n){e.ref_rk=s(t,"id"),e.state=0,e.state_type=1,e.id=this.getRoutingKey(e),e.output="declare ticket"},filter:function(e){return s(e,"ack.isAck")},handle:function(e){var t=this.getDisplayRecord("declareticket",e[0]);alert("ticketform"),this.getEventForm("declareticket",t,e,"ticketform")},transform:function(e,t){console.log("transform method for declare ticket",e,t),e.set("ticket_declared_author",t.author),e.set("ticket_declared_date",i.getNow())}},assocticket:{extract:function(e,t,n){e.ref_rk=s(t,"id"),e.state=0,e.state_type=1,e.id=this.getRoutingKey(e),void 0===n?e.output=l("Associated ticket number"):(e.output=s(n,"output"),e.ticket=s(n,"ticket"))},filter:function(e){return s(e,"ack.isAck")},handle:function(e){var t=this.getDisplayRecord("assocticket",e[0]);this.getEventForm("assocticket",t,e)},transform:function(e,t){console.log("transform method for assoticket",e,t),e.set("ticket",t.ticket),e.set("ticket_date",i.getNow())}},cancel:{extract:function(e,t,n){e.ref_rk=s(t,"id"),e.state=0,e.state_type=1,void 0!==n&&(e.output=s(n,"output")),e.cancel=1},filter:function(e){return s(e,"ack.isAck")},handle:function(e){var t=this.getDisplayRecord("cancel",e[0]);this.getEventForm("cancel",t,e)},transform:function(e,t){console.log("transform method for cancel -> crecords",e,"record",t),e.set("ack.isCancel",!0),e.set("ack.isAck",!1),e.set("status",4),e.set("cancel",{comment:t.output,timestamp:i.getNow(),author:t.author,previous_status:t.state})}},recovery:{extract:function(e,t,n){a(t,"state",0)},filter:function(e){return!1},handle:function(e){var t=e[0];this.submitEvents([t],t,"recovery")},transform:function(e,t){}},uncancel:{extract:function(e,t,n){if(e.ref_rk=s(t,"id"),e.state_type=1,e.state=0,e.cancel=0,void 0!==n){var o=s(n,"output");o||(o=" "),e.output=o}},filter:function(e){return s(e,"ack.isCancel")},handle:function(e){var t=this.getDisplayRecord("uncancel",e[0]);this.getEventForm("uncancel",t,e)},transform:function(e,t){console.log("transform method for uncancel -> crecords",e,"record",t),e.set("ack.isCancel",!1),e.set("ack.isAck",!0),e.set("status",e.get("cancel.previous_status")),c(e.get("ack"))?e.set("ack",{comment:t.output,timestamp:i.getNow(),author:t.author,isAck:!0}):e.set("ack",e.get("ack"))}},changestate:{extract:function(e,t,n){c(n)||(e.state=s(n,"state"),e.output=s(n,"output")),e.event_type="check",e.keep_state=!0,e.state_type=1},filter:function(e){return s(e,"state")},handle:function(e){var t=this.getDisplayRecord("changestate",e[0]);this.getEventForm("changestate",t,e)},transform:function(e,t){console.log("transform method for ack changestate",e,t),e.set("state",t.state),0===t.state?e.set("ack",void 0):e.set("cancel",void 0),a(e,"change_state_output",s(t,"output")),a(e,"keep_state",!0)}},user:{extract:function(e,t,n){e.output=s(t,"output"),e.display_name=s(this,"login.firstname")+" "+s(this,"login.lastname")},filter:function(e){return!1},handle:function(e){var t=this.getDisplayRecord("user",e[0]);r.info(l('event "user" sent')),this.submitEvents(e,t,"user")},transform:function(e,t){console.log("transform method for user",e,t)}},comment:{extract:function(e,t,n){e.referer=s(t,"referer"),e.output=s(t,"output"),e.display_name=s(this,"login.firstname")+" "+s(this,"login.lastname")},filter:function(e){return!1},handle:function(e){var t=this.getDisplayRecord("comment",e[0]);r.info(l('event "comment" sent')),this.submitEvents(e,t,"comment")},transform:function(e,t){console.log("transform method for comment",e,t)}}},hasEventProcessorForType:function(e){return void 0!==this.event_processors[e]},processEvent:function(e,t,n){if(this.hasEventProcessorForType(e)){var o=this.event_processors[e][t];return o.apply(this,n)}},actions:{sendEvent:function(e,t){console.group("sendEvent:",arguments),this.stopRefresh();var n=[];if(c(t)){var o=s(this,"widgetData.content"),i=o.filterBy("isSelected",!0);if(n=this.filterUsableCrecords(e,i),console.log("events:",e,n),!n.length)return void r.warning("No matching event found for event:",e)}else console.log("event:",e,t),n.pushObject(t);this.processEvent(e,"handle",[n]),this.setPendingOperation(n),console.groupEnd()}}});t.register("mixin:sendevent",u)}}),Ember.Application.initializer({name:"WeatherWidget",after:"WidgetFactory",initialize:function(e,t){var n=e.lookupFactory("factory:widget"),o=Ember.get,i=Ember.set,r=Ember.isNone,s=window.Handlebars,a=n("weather",{needs:["application"],init:function(){this._super(),i(this,"worst_state",void 0),i(this,"sub_weather",[]),this.fetchStates(),console.log("Setting up weather widget : "+o(this,"config.title"))},actions:{goToInfo:function(e){console.log("goToInfo",e);var t=this.transitionToRoute("/userview/"+o(this,"config.destination_view")),n=o(this,"model.filter_pattern");t.promise.then(function(t){console.log("transition done",t);var r=o(t,"controller.content.containerwidget");r=o(r,"_data.items")[0],r=o(r,"widget"),console.log(r),console.log("filter_pattern",n);var a=n,c=e,l=s.compile(a)(c);console.log("compiledFilterPattern",l),""!==l&&(o(r,"volatile")||i(r,"volatile",{}),i(r,"volatile.forced_filter",l),i(r,"rollbackable",!0),i(r,"title","Info on events :",e.title))})}},title:function(){return o(this,"config.title")}.property("config.title"),icon:function(){return this.class_icon(o(this,"worst_state"))}.property("worst_state"),class_icon:function(e){return["ion-ios7-sunny-outline","ion-ios7-cloudy-outline","ion-ios7-rainy-outline","ion-ios7-thunderstorm-outline","ion-checkmark-round"][e]},background:function(){return this.class_background(o(this,"worst_state"))}.property("worst_state"),class_background:function(e){return["eventLikeGreen","eventLikeYellow","eventLikeOrange","eventLikeRed","eventLikePurple"][e]},fetchStates:function(){var e=this,t=o(e,"config.event_selection"),n=[];if(console.log("rk information for weather",n),!t||!t.length)return void console.warn("Widget weather "+o(this,"title")+" No rk found, the widget may not be configured properly");for(var r=t.length,s={},a=0;r>a;a++){var c=t[a];s[c.rk]=c.label,n.push(c.rk)}i(e,"rksLabels",s);var l={limit:0,ids:JSON.stringify(n)};$.ajax({url:"/rest/events",data:l,success:function(t){t.success?e.computeWeather(t.data):console.error("Unable to load event information for weather widget from API"),e.trigger("refresh"),console.log(" + Weather content",o(e,"config.event_selection"))}})},computeWeather:function(e){console.group("computing weathers");for(var t=0,n=[],s=0,a=0,c=o(this,"rksLabels"),l=0,u=e.length;u>l;l++){var d=e[l];console.log("subweather event",d);var f=o(d,"ack.isAck"),p=o(d,"ack"),h=o(d,"resource")||"",m=o(d,"event_type"),g=o(d,"component")||"",v=o(d,"id");f?(console.log("one more ack count"),s++,a=4):(console.log("normal ack count"),a=d.state),d.state>t&&(!p||p&&!f)&&(t=d.state),console.log("computedState",a);
var b=g;"selector"===b&&(b="");var y=b+" "+h;o(this,"use_labels")&&(y=c[v]||y);var k={rk:v,event_type:m,isSelector:"selector"===m,component:g,resource:h,title:y,custom_class:this.class_background(a),timestamp:o(d,"timestamp"),previous_state_change_ts:o(d,"previous_state_change_ts")};"selector"===m&&this.generateSelectorFilter(d,k),n.pushObject(k)}if(console.log("The data lenght => ",e.length),1===e.length){i(this,"singleEvent",!0);var E=o(e[0],"output");!r(E)&&E.length>150&&(E=E.substr(0,150)+" ..."),i(this,"singleEventOutput",E)}else i(this,"singleEvent",!1);s===e.length&&(t=4),console.log("worst_state",t),console.log("weather content",{sub_weathers:n,worst_state:t}),i(this,"sub_weather",n),i(this,"worst_state",t),console.groupEnd(),this.trigger("refresh")},generateSelectorFilter:function(e,t){console.log("generateSelectorFilter",arguments);var n={limit:1,ids:JSON.stringify(o(e,"selector_id"))};$.ajax({url:"/rest/object",data:n,success:function(e){if(e.data.length>=1){var n={$or:[]},r=e.data[0],s=o(r,"include_ids"),a=o(r,"exclude_ids"),c=o(r,"mfilter");s&&s.length&&n.$or.pushObject({_id:{$in:s}}),a&&a.length&&n.$or.pushObject({_id:{$nin:a}}),c&&n.$or.pushObject(JSON.parse(c)),i(t,"selector_filter",JSON.stringify(n)),console.log("selector filter",n)}}})},refreshContent:function(){this.fetchStates(),this._super()}});t.register("widget:weather",a)}});
//# sourceMappingURL=dist/brick.map.js