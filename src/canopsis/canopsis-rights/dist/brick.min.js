Ember.Application.initializer({name:"component-right-checksum",after:"RightsRegistry",initialize:function(e,t){var i=e.lookupFactory("registry:rights"),r=Ember.get,o=Ember.set,s=Ember.isNone,n=(Ember.String.loc,Ember.Component.extend({right:void 0,checksum1flag:void 0,checksum2flag:void 0,checksum4flag:void 0,checksum8flag:void 0,computedNumericChecksum:void 0,init:function(){var e=r(this,"right");s(r(e,"data"))&&o(e,"data",Ember.Object.create()),r(e,"checksum")||o(e,"checksum",1);var t=r(e,"checksum");t>=8&&(t-=8,o(this,"checksum8flag",!0)),t>=4&&(t-=4,o(this,"checksum4flag",!0)),t>=2&&(t-=2,o(this,"checksum2flag",!0)),t>=1&&(t-=1,o(this,"checksum1flag",!0)),this._super(),this.recomputeNumericChecksum()},checksumType:function(){var e=r(this,"right.name"),t=i.getByName(e);return t&&t._data?t._data.type:void 0}.property("right.name"),checksumIsRW:function(){return"RW"===r(this,"checksumType")}.property("checksumType"),checksumIsCRUD:function(){return"CRUD"===r(this,"checksumType")}.property("checksumType"),actions:{toggleRightChecksum:function(e){var t=r(this,"right");console.info("toggleRightChecksum action",arguments);var i=r(this,"checksum"+e+"flag");i?o(this,"checksum"+e+"flag",!1):o(this,"checksum"+e+"flag",!0);var s=r(this,"onChecksumChange"),n=r(this,"onChecksumChangeTarget");s&&n&&n[s](t)}},checksum8Class:function(){return r(this,"checksum8flag")?"btn btn-xs btn-success active":"btn btn-xs btn-danger"}.property("checksum8flag"),checksum4Class:function(){return r(this,"checksum4flag")?"btn btn-xs btn-success active":"btn btn-xs btn-danger"}.property("checksum4flag"),checksum2Class:function(){return r(this,"checksum2flag")?"btn btn-xs btn-success active":"btn btn-xs btn-danger"}.property("checksum2flag"),checksum1Class:function(){return r(this,"checksum1flag")?"btn btn-xs btn-success active":"btn btn-xs btn-danger"}.property("checksum1flag"),recomputeNumericChecksum:function(){var e=r(this,"checksum8flag"),t=r(this,"checksum4flag"),i=r(this,"checksum2flag"),s=r(this,"checksum1flag"),n=0;e&&(n+=8),t&&(n+=4),i&&(n+=2),s&&(n+=1),o(this,"computedNumericChecksum",n),o(this,"right.checksum",n)}.observes("checksum8flag","checksum4flag","checksum2flag","checksum1flag")}));t.register("component:component-right-checksum",n)}}),Ember.Application.initializer({name:"component-rights-action",after:"RightsRegistry",initialize:function(e,t){var i=e.lookupFactory("registry:rights"),r=Ember.get,o=(Ember.set,Ember.isNone,Ember.String.loc,Ember.Component.extend({value:void 0,description:function(){var e=r(this,"value"),t=i.getByName(e);return t&&t._data?t._data.desc:void 0}.property("value")}));t.register("component:component-rights-action",o)}}),Ember.Application.initializer({name:"component-rightsrenderer",initialize:function(e,t){var i=Ember.get,r=Ember.Component.extend({rightsArray:function(){for(var e=i(this,"content")||{},t=Ember.A(),r=Ember.keys(e),o=0,s=r.length;s>o;o++)t.pushObject({name:r[o]});return t}.property("content")});t.register("component:component-rightsrenderer",r)}}),Ember.Application.initializer({name:"component-rightsselector",after:["RightsRegistry","component-dictclassifiedcrecordselector"],initialize:function(e,t){var i=(e.lookupFactory("registry:rights"),e.lookupFactory("component:component-dictclassifiedcrecordselector")),r=Ember.get,o=Ember.set,s=Ember.isNone,n=i.extend({nameKey:"_id",idKey:"_id",actions:{selectItem:function(){this.recomputeValue()},unselectItem:function(){this.recomputeValue()}},classifiedItems:function(){var e=r(this,"items"),t=r(this,"valueKey")||r(this,"valueKeyDefault"),i=r(this,"nameKey")||r(this,"nameKeyDefault");console.log("recompute classifiedItems",r(this,"items"),t);for(var o=Ember.Object.create({all:Ember.A(),byClass:{}}),n=0,c=e.length;c>n;n++){var a=e[n],l={name:a.get(i)};if(t&&(console.log("add valueKey",a.get(t)),l.value=a.get(t),console.log("objDict value",l)),this.serializeAdditionnalData(a,l),o.all.pushObject(Ember.Object.create(l)),possibleClassSplit=l.name.split("_"),possibleClassSplit.length>1){var u=possibleClassSplit[0];s(o.byClass[u])&&(o.byClass[u]=[]),o.byClass[u].pushObject(l)}}return console.log("recompute classifiedItems done",o),o}.property("items","items.@each"),recomputeValue:function(){console.group("recomputeValue",r(this,"selectionUnprepared"));var e=r(this,"selectionUnprepared"),t={};if(e&&e.length)for(var i=0,s=e.length;s>i;i++){var n=e[i];console.log("iteration",n,r(n,"checksum")),o(t,n.name,{checksum:r(n,"checksum")||19})}console.log("buffer",t),o(this,"content",t),console.groupEnd()}.observes("selectionUnprepared","selectionUnprepared.@each","selectionUnprepared.@each.checksum"),findItems:function(){var e=this,t=this.get("store_"+r(this,"elementId")),i={start:0,limit:1e4};i.filter=JSON.stringify({crecord_type:this.get("crecordtype")}),console.log("findItems",this.get("crecordtype"),i),t.findQuery("action",i).then(function(t){e.set("widgetDataMetas",t.meta);var i=t.get("content");e.set("items",i),Ember.run.scheduleOnce("afterRender",{},function(){e.rerender()}),e.extractItems(i)})},deserializeAdditionnalData:function(e){return console.log("deserializeAdditionnalData",arguments),{checksum:e.checksum}},serializeAdditionnalData:function(e){console.log("serializeAdditionnalData",arguments)}});t.register("component:component-rightsselector",n)}}),Ember.Application.initializer({name:"ViewrightsForm",after:["FormFactory","FormsUtils","DataUtils"],initialize:function(e,t){var i=e.lookupFactory("factory:form"),r=Ember.get,o=Ember.set,s=Ember.isNone,n=i("viewrightsform",{isLoading:!0,checksums:[{value:void 0,label:__("Nothing")},{value:15,label:__("Can view")}],rolesChanged:function(){for(var e=r(this,"formContext.id").replace(".","_"),t=Ember.A(),i=r(this,"roles"),s=0,n=i.length;n>s;s++){var c=i[s],a=c.get("rights."+e+".checksum");-1===a&&(a=0),console.log("rolesChanged",c,a),t.pushObject({role:c.id,checksum:a,name:e})}Ember.setProperties(this,{rightsArray:t}),this.computeRolesWithoutRights(),o(this,"addedRole",r(this,"rolesWithoutRights").objectAt(0).get("_id"))},onRightChecksumChange:function(e){console.log("onRightChecksumChange",e,this);var t=this,i=r(e,"role"),s=r(this,"formContext.id").replace(".","_"),n=r(this,"roles").findBy("crecord_name",i);o(n,"rights."+s+".checksum",r(e,"checksum")),t.rolesChanged(),n.save()},computeRolesWithoutRights:function(){for(var e=r(this,"roles"),t=Ember.A(),i=r(this,"formContext.id").replace(".","_"),n=0,c=e.length;c>n;n++){var a=e[n],l=r(a,"rights."+i+".checksum");(s(l)||0===l||-1===l)&&t.pushObject(a)}o(this,"rolesWithoutRights",t)},actions:{show:function(){var e=DS.Store.create({container:r(this,"container")}),t=this;e.findQuery("role",{}).then(function(e){o(t,"roles",r(e,"content")),t.rolesChanged(),Ember.setProperties(t,{isLoading:!1,roles:r(e,"content")})})},addNewRight:function(){var e=r(this,"roles"),t=this,i=r(this,"addedRole");void 0===i&&(i=r(this,"rolesWithoutRights").objectAt(0).get("_id")),i=e.findBy("_id",r(this,"addedRole"));var n=r(this,"formContext.id").replace(".","_");s(r(i,"rights"))&&o(i,"rights",{}),s(r(i,"rights."+n))&&o(i,"rights."+n,{checksum:4}),o(i,"rights."+n+".checksum",4),o(this,"isLoading",!1),t.rolesChanged(),i.save()}}});t.register("form:viewrights",n)}}),Ember.Application.initializer({name:"RightsRegistry",after:"AbstractClassRegistry",initialize:function(e,t){AbstractClassRegistry=e.lookupFactory("registry:abstractclass");var i=AbstractClassRegistry.create({name:"rights",tableColumns:[{title:"name",name:"name"},{title:"description",name:"description"}]});t.register("registry:rights",i)}}),Ember.Application.initializer({name:"CanopsisRightsUserviewAdapterReopen",after:["DataUtils","UserviewAdapter"],initialize:function(e,t){var i=e.lookupFactory("utility:data"),r=e.lookupFactory("adapter:userview"),o=Ember.get,s=Ember.set,n=Ember.isNone;r.reopen({updateRecord:function(e,t,r){if(rightsRegistry=i.getEmberApplicationSingleton().__container__.lookupFactory("registry:rights"),formattedViewId=o(r,"id").replace(".","_"),n(rightsRegistry.getByName(formattedViewId))){var c=i.getStore().createRecord("action",{enable:!0,crecord_type:"action",type:"RW",_id:formattedViewId,id:formattedViewId,crecord_name:formattedViewId,desc:"Rights on view : "+o(r,"crecord_name")});c.save(),rightsRegistry.add(c,o(c,"crecord_name"));var a=i.getLoggedUserController(),l=o(a,"record.rights");s(l,formattedViewId,{checksum:7});var u=o(a,"record");u.save()}return this._super.apply(this,arguments)},deleteRecord:function(e,t,r){rightsRegistry=i.getEmberApplicationSingleton().__container__.lookupFactory("registry:rights"),formattedViewId=o(r,"id").replace(".","_");var s=rightsRegistry.getByName(formattedViewId);return console.log("deleteRecord",formattedViewId,rightsRegistry,s),s.deleteRecord(),s.save(),this._super.apply(this,arguments)}})}}),Ember.Application.initializer({name:"CanopsisRightsCrudMixinReopen",after:["CrudMixin","RightsflagsUtils"],initialize:function(e,t){var i=e.lookupFactory("mixin:crud"),r=e.lookupFactory("utility:rightsflags"),o=Ember.get;Ember.set,Ember.isNone,Ember.String.loc;i.reopen({userCanReadRecord:function(){if("root"===o(this,"user"))return!0;var e=o(this,"listed_crecord_type"),t=o(this,"rights.models_"+e+".checksum");return r.canRead(t)}.property("config.listed_crecord_type"),userCanCreateRecord:function(){if("root"===o(this,"user"))return!0;var e=o(this,"listed_crecord_type"),t=o(this,"rights.models_"+e+".checksum");return r.canCreate(t)}.property("config.listed_crecord_type"),userCanUpdateRecord:function(){if("root"===o(this,"user"))return!0;var e=o(this,"listed_crecord_type"),t=o(this,"rights.models_"+e+".checksum");return r.canUpdate(t)}.property("config.listed_crecord_type"),userCanDeleteRecord:function(){if("root"===o(this,"user"))return!0;var e=o(this,"listed_crecord_type"),t=o(this,"rights.models_"+e+".checksum");return r.canDelete(t)}.property("config.listed_crecord_type")})}}),Ember.Application.initializer({name:"CanopsisRightsShowviewbuttonMixinReopen",after:["ShowviewbuttonMixin","FormsUtils"],initialize:function(e,t){var i=e.lookupFactory("utility:forms"),r=e.lookupFactory("mixin:showviewbutton"),o=Ember.get,s=Ember.String.loc;r.reopen({init:function(){return this.get("partials.itemactionbuttons").pushObject("actionbutton-viewrights"),this._super()},actions:{editUserviewRights:function(e){var t=o(e,"crecord_name");console.log("editUserviewRights view",e,t);var r=s("Edit rights for view : ")+'"'+t+'"';i.showNew("viewrightsform",e,{title:r})}}})}}),Ember.Application.initializer({name:"CanopsisRightsApplicationRouteReopen",after:["ApplicationRoute","DataUtils"],initialize:function(e,t){var i=e.lookupFactory("route:application"),r=e.lookupFactory("utility:data"),o=Ember.get;Ember.set,Ember.isNone;i.reopen({beforeModel:function(e){rightsRegistry=r.getEmberApplicationSingleton().__container__.lookupFactory("registry:rights");var t=DS.Store.create({container:o(this,"container")}),i=t.findQuery("action",{limit:1e3});i.then(function(e){for(var i=0,r=e.content.length;r>i;i++){var s=e.content[i];rightsRegistry.add(s,o(s,"crecord_name"))}t.destroy()});var s=this._super(e),n=Ember.A([s,i]);return Ember.RSVP.Promise.all(n)}})}}),Ember.Application.initializer({name:"CanopsisRightsUserviewRouteReopen",after:["UserviewRoute","RightsflagsUtils"],initialize:function(e,t){var i=e.lookupFactory("route:userview"),r=e.lookupFactory("utility:rightsflags"),o=Ember.get,s=Ember.set;Ember.isNone;i.reopen({beforeModel:function(e){var t=(this.controllerFor("application"),this.controllerFor("login")),i=o(e,"params.userview.userview_id");i=i.replace(".","_");var n=o(t,"record.rights."+i+".checksum"),c=o(t,"record._id");return r.canRead(n)||"view_404"===i||"view_401"===i||"root"===c||s(e,"hasToBeRedirected",!0),this._super(e)},afterModel:function(e,t){var i=o(t,"hasToBeRedirected");return i&&this.transitionTo("/userview/view.404"),this._super(e,t)},actions:{toggleEditMode:function(){var e=this.controllerFor("login"),t=o(this,"controller.model.id");t=t.replace(".","_");var i=o(e,"record._id"),s=o(e,"record.rights."+t+".checksum");(r.canWrite(s)||"root"===i)&&this._super()}}})}}),Ember.Application.initializer({name:"CanopsisRightsUimaintabcollectionWidgetReopen",after:["RightsflagsUtils","UimaintabcollectionWidget","WidgetsRegistry"],initialize:function(e,t){var i=Ember.get,r=(Ember.set,Ember.isNone,Ember.String.loc,e.lookupFactory("registry:widgets"),e.lookupFactory("widgetbase:uimaintabcollection")),o=e.lookupFactory("utility:rightsflags");r.reopen({loggedaccountId:Ember.computed.alias("controllers.login.record._id"),loggedaccountRights:Ember.computed.alias("controllers.login.record.rights"),isViewDisplayable:function(e){var t=i(this,"loggedaccountId"),r=i(this,"loggedaccountRights");return"root"===t?!0:e&&o.canRead(i(r,e+".checksum"))},userCanShowEditionMenu:function(){if("root"===i(this,"loggedaccountId"))return!0;var e=i(this,"loggedaccountRights");return i(e,"tabs_showeditionmenu.checksum")?!0:!1}.property(),userCanEditView:function(){if("root"===i(this,"loggedaccountId"))return!0;var e=i(this,"loggedaccountRights"),t=i(this,"currentViewId");return t=t.replace(".","_"),o.canWrite(i(e,t+".checksum"))?!0:!1}.property("currentViewId"),userCanCreateView:function(){if("root"===i(this,"loggedaccountId"))return!0;var e=i(this,"loggedaccountRights");return i(e,"userview_create.checksum")?!0:!1}.property()}),t.register("widget:uimaintabcollection",r)}}),Ember.Application.initializer({name:"RightsflagsUtils",initialize:function(e,t){var i={canRead:function(e){return(e>>2)%2===1},canWrite:function(e){return(e>>1)%2===1},canCreate:function(e){return(e>>3)%2===1},canUpdate:function(e){return this.canWrite(e)},canDelete:function(e){return e%2===1}};t.register("utility:rightsflags",i)}});
//# sourceMappingURL=dist/brick.map.js